<html>
 <head>
  <title>N-Screen</title>

  <script type="text/javascript" src="conf.js"></script>
  <script type="text/javascript" src="lib/jquery-1.4.4.min.js"></script>
  <script type="text/javascript" src="lib/jquery-ui-1.8.10.custom.min.js"></script>
  <script type="text/javascript" src="lib/fix_date.js"></script>
  <script type="text/javascript" src="lib/jquery.ui.touch.js"></script>

  <script type="text/javascript" src="lib/tidy_dbpedia.js"></script>
  <script type="text/javascript" src="lib/strophe.js"></script>
  <script type="text/javascript" src="lib/strophe.roster.js"></script>
  <script type="text/javascript" src="lib/strophe_code.js"></script><!-- depends on jquery -->


  <link type="text/css" href="css/jquery-ui-1.8.10.custom.css" rel="Stylesheet" />
  <link type="text/css" rel="stylesheet" href="css/3_col.css" >
  <link type="text/css" rel="stylesheet" href="css/basic.css" />

<!-- workaround - http://stackoverflow.com/questions/2894230/fake-user-initiated-audio-tag-on-ipad -->

  <script type="text/javascript">
        document.onclick = function(){
          document.getElementById("a1").load();
          document.getElementById("a2").load();
        }
  </script>
 </head>


<body onload="javascript:init()">

<!-- workaround for audio problems on ipad - http://stackoverflow.com/questions/2894230/fake-user-initiated-audio-tag-on-ipad -->

<div id="junk" style="display:none">
  <audio src="sounds/x4.wav" id="a1" preload="auto"  autobuffer="autobuffer" controls="" ></audio>
  <audio src="sounds/x1.wav" id="a2" preload="auto"  autobuffer="autobuffer" controls="" ></audio>
</div>

<script type="text/javascript">

function init(){

   //load the start url or random if no start_url (see conf.js)
   //get a random set of starting points
   do_start("progs",start_url);
 
   //gather up parameters
   //we expect "#" and then separated by "&"
   var pr = window.location.hash;

   //alert(pr);
   pr_arr = pr.split("&");

   for(x in pr_arr){
     var pr = pr_arr[x];

     if(pr.match("user_profile")){
         start_url=pr.substring(14);
     }
     if(pr.match("user_name")){
         my_name=pr.substring(11);
     }
     if(pr.match("video_files")){
         video_files=pr.substring(12);
         if(!video_files.match(/^file:\/\//)){
            video_files = "file:///"+video_files;
         }
         if(!video_files.match(/\/$/)){
            video_files = video_files+"/";
         }
     }
   }


   //ask the user for their name to continue
   //unless it's specified as a parameter

   if(!my_name || my_name==""){
        show_ask_for_name();
   }else{
        ask_for_friendship(far);
   }

}


//display suggestions based on id

function insert_suggest2(id) {
      var div = $("#"+id);
      var title = div.find(".p_title").text();
      var description = div.find(".description").text();
      var video = div.attr("href");
      var img = div.find(".img").attr("src");
      html = [];
      html.push("<div id=\""+id+"_history\" href=\""+video+"\"  class=\"ui-widget-content button draggable2 newClass\">");
      html.push("<img class=\"img\" src=\""+img+"\" height=\"100\"/>");
      html.push("<p class=\"p_title\">"+title+"</p>");
      html.push("<p class=\"description\">"+description+"</b></p>");
      html.push("</div>");
      $('#history').prepend(html.join(''));

      $('#pane2').html("One moment please....");

      $.ajax({
       url: get_related_url(id),
       dataType: "json",
         success: function(data){
          recommendations(data,"progs2");
         },
         error: function(jqXHR, textStatus, errorThrown){
         //alert("oh dear "+textStatus);
         }
      });

}

//get a random selection

function do_random(el){

  $("#rec_pane").html("<h3>Random selection</h3>");

  //id for element to add it to
  if(!el){
    el = "progs";
  }

  $.ajax({
    url: random_url,
    dataType: "json",
    success: function(data){
      random(data,el);
    },
    error: function(jqXHR, textStatus, errorThrown){
    //console.log("nok "+textStatus);
    }

  });

}


// start url if different from do_random

function do_start(el,start_url){


  //id for element to add it to
  if(!el){
    el = "progs";
  }

  if(start_url){
    $("#rec_pane").html("<h3>Starting Points</h3>");

    $.ajax({
      url: start_url,
      dataType: "json",
      success: function(data){
        random(data,el);
      },
      error: function(jqXHR, textStatus, errorThrown){
      //console.log("nok "+textStatus);
      }

    });

  }else{
     do_random(el);
  }
}


//search for txt
       
function do_search(txt){
  txt = txt.toLowerCase();
  $('#rec_pane').html("One moment please....");

  $.ajax({
    url: get_search_url(),
    dataType: "json",
    success: function(data){
      search_results(data,txt,"progs");
    },
    error: function(jqXHR, textStatus, errorThrown){
    //console.log("nok "+textStatus);
    }

  });

}    


//make titles look a bit more readable

function capitalise(txt){

  txt = txt.replace(/:/g," : ");
  var arr = txt.split(/[.|,| |\(|\)|\[|\]]/);
  var arr2 = [];
  for(x in arr){
    var str = arr[x];
    var letter = str.substr(0,1);
    arr2.push(letter.toUpperCase() + str.substr(1).toLowerCase());
  }

  return arr2.join(" ");
}


//called when random results are returned

function random(result,el){
//pass to the common bit of processing

  var suggestions = [];

  if(local_search){
  //if it's local search then random just returns everything
  //so do some processing
    for (var i =0;i<11;i++){
      var rand = Math.floor(Math.random()*result.length)
      suggestions.push(result[rand]);
    }
  }else{
     suggestions = result;

  }

  process_json_results(suggestions,el);
}


//called when recommendations are returned

function recommendations(result,el){
   if(!el){
     el = "progs2";
   }
          var suggestions = result["suggestions"];
          var pid_title = result["title"];
          if(suggestions.length==0){
            if(pid_title){
               $("#pane2").html("<h3>Sorry, nothing found related to "+pid_title+"</h3>");
            }else{
               $("#pane2").html("<h3>Sorry, nothing found</h3>");
            }
            $("#"+el).html("");
          }else{
            if(pid_title){
               $("#pane2").html("<h3>Related to "+pid_title+"</h3>");
            }else{
               $("#pane2").html("<h3>Related</h3>");
            }
            process_json_results(suggestions,el,pid_title);
          }
}

//handle inserted search results

function search_results(result,current_query,el){
   if(!el){
     el = "progs";
   }

   suggestions = [];

   if(local_search){
     //if it's local search then search just returns everything
     //so do some processing

       for (r in result){
         var title = result[r]["title"];
         var desc = result[r]["description"];
         if(title.toLowerCase().match(current_query)||(desc.toLowerCase().match(current_query))){
            suggestions.push(result[r]);
         }
       }
   }else{
      suggestions = result;
   }

          if(suggestions.length==0){
               $("#rec_pane").html("<h3>Sorry, nothing found for "+current_query+"</h3>");
               $("#"+el).html("");
          }else{
               $("#rec_pane").html("<h3>Search results for "+current_query+"</h3>");
               process_json_results(suggestions,el);
          }

}



//process the results for displaying

function process_json_results(suggestions,ele,pid_title){

          var max = 10
          var s ="";
          var html = [];

          if (suggestions.length>0){
            var count = 0;
            var num = suggestions.length/2;
            for (r in suggestions){
              if(count<max){
                count = count + 1;
                var title = suggestions[r]["title"];
                var desc = suggestions[r]["description"];
                var id = suggestions[r]["id"];
                var img = suggestions[r]["image"];

                var video = suggestions[r]["video"];
                var channel = suggestions[r]["channel"];
                var time_offset = suggestions[r]["time_offset"];

                var explanation = suggestions[r]["explanation"];

                var catz = suggestions[r]["categories"];
                var cats ="";
                if(catz){
                  for(var i in catz){
                    var tn = catz[i]["term_name"];
                    tn = tn.toLowerCase();
                    var tnum = catz[i]["term"];
                    var freq = catz[i]["freq"];
                    if(freq > 1){ //i.e. if it links to something other than this
                      cats = cats+" "+tn;
                    }
                    if(i<catz.length-1){
                      cats = cats+",";
                    }
                  }
                }


//processing for local files option
                if(video_files){
                    video = video_files+""+video;
                }

//processing for a particular form of time offsets
//T00:18:31:15F25
                if(video && time_offset){
                   var offs = time_offset.replace(/T/,"")
                   var aa = offs.split(":");
                   var secs = parseInt(aa[1])*60+parseInt(aa[2]);
                   video = video+"#"+secs
                }


                if(video && id){

                  if(pid_title){
                     html.push("<div id=\""+id+"\" href=\""+video+"\" class=\"ui-widget-content button draggable3\">");
                  }else{
                     html.push("<div id=\""+id+"\" href=\""+video+"\" class=\"ui-widget-content button draggable2\">");
                  }
                  html.push("<div><img class=\"img\" src=\""+img+"\" height=\"100\"/></div>");
                  html.push("<p class=\"p_title\">"+title+"</p>");
                  html.push("<div clear=\"both\"></div>");
                  if(desc && desc!=""){
                    html.push("<span class=\"large description\">"+desc+"</span>");
                  }
                  if(explanation && explanation!=""){
                    //see tidy_dbpedia.js
                    //idea is that the user doesn't need to see piles of junk
                    explanation = clean_up(explanation);

                    //i.s. if this is caled because it's related content, say why
                    if(pid_title && explanation){
                        html.push("<span class=\"explain\"><b>Related to "+pid_title+" by "+explanation+"</b></span>");
                    }

                  }
                  if(cats && cats!=""){
                    html.push("<span class=\"large\"><i>"+cats+"</i></span>");
                  }
                  html.push("</div>");
                }
              }//end if count < max
            }

            $("#"+ele).html(html.join(''));

          }


//   $(".button").unbind('refresh');
//   $(".button").unbind('refresh_buttons');
   $(document).trigger('refresh');
   $(document).trigger('refresh_buttons');
}

        
//show disconnect overlay

function show_disconnect(){
	$(function() {
		$( "#disconnect_overlay" ).dialog({ maxHeight: 50 });
	});

}
    

//ask the user for their name

function show_ask_for_name(){
	$(function() {
		$( "#ask_for_name_overlay" ).dialog({ maxHeight: 100 });
	});

}
    

function add_name(){
  var name = document.forms["myname"].nick.value;
  if(name){
    my_name=name;
//??trigger
    $(document).trigger('send_name');
  }
  $(function() {
      $( "#ask_for_name_overlay" ).dialog("close");
  });

}

</script>



<div id="roster_wrapper">
  <div id="side-a">
    <div id="roster"></div>
  </div>
</div>

<br clear="both"/>

<div>
  <div id="header">
    <span id="title">Hello! Please wait a sec...</span>

    <span class="form" >
      <form onsubmit='javascript:do_search(this.search_text.value);return false;'>
	<button onclick='javascript:do_random()' type="button">Shuffle!</button>
	<input type="text" id="search_text" name="search_text" />
	<input name="search" value="Search" value="Search" type="submit"/>
      </form>
     </span>

  </div>
</div>
        

<br clear="both"/>

<div id="container">


  <div id="side-b">
    <div class="ui-widget-content draggable2">
        <div id="rec_pane"><h3>Random Starting points</h3></div>
    </div>
   <div id="progs">
   </div>
  </div>

  <div id="content">
      <div class="flatter_sm ui-widget-content draggable2">
        <div><h3>History</h3></div>
      </div>
      <div id="history">
      </div>
  </div>
            
  <div id="side-c">
    <div class="flatter ui-widget-content draggable3">
        <div><h3><span id="pane2">Related</span></h3></div>
    </div>
   <div id="progs2">
   </div>
  </div>


 <br clear="both" />

<p><small>Status:
<span id="demo">
<span id="out"></span>
</span></small></p>


<div class="simple_overlay" id="disconnect_overlay">
        <!-- the external content is loaded inside this tag -->
        <div class="contentWrap">
	    <h2>Disconnected - <a href="javascript:location.reload(true)">Reload</a></h2>
        </div>
</div>

<div class="simple_overlay" id="ask_for_name_overlay">
        <div class="contentWrap">
	    <h2>What's your name?</h2>
            <form onsubmit="javascript:add_name();return false;" id="myname">
               <input type="text" name="nick"/>
               <input type="submit" name="go" value="Start" />               
            </form>
        </div>
</div>


</body>
</html>


